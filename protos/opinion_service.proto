syntax = "proto3";

package opinion_service;

// Opinion Analysis Service
service OpinionAnalysisService {
  // Classify a single opinion
  rpc ClassifyOpinion(ClassifyRequest) returns (ClassifyResponse);

  // Classify multiple opinions in batch
  rpc ClassifyBatch(BatchClassifyRequest) returns (BatchClassifyResponse);

  // Match opinions to a topic
  rpc MatchOpinionsToTopic(MatchRequest) returns (MatchResponse);

  // Generate conclusion for a topic with opinions
  rpc GenerateConclusion(ConclusionRequest) returns (ConclusionResponse);

  // Full pipeline: match + classify + conclude
  rpc AnalyzeTopic(TopicAnalysisRequest) returns (TopicAnalysisResponse);
}

// Messages for Opinion Classification
message ClassifyRequest {
  string text = 1;
}

message ClassifyResponse {
  string opinion_type = 1;
  float confidence = 2;
  map<string, float> probabilities = 3;
}

message BatchClassifyRequest {
  repeated string texts = 1;
}

message BatchClassifyResponse {
  repeated ClassifyResponse results = 1;
}

// Messages for Topic Matching
message MatchRequest {
  string topic_id = 1;
  string topic_text = 2;
  repeated Opinion opinions = 3;
  int32 top_k = 4;
  optional float threshold = 5;
}

message Opinion {
  string id = 1;
  string text = 2;
}

message MatchResponse {
  repeated MatchedOpinion matches = 1;
}

message MatchedOpinion {
  string opinion_id = 1;
  string opinion_text = 2;
  float similarity = 3;
}

// Messages for Conclusion Generation
message ConclusionRequest {
  string topic_text = 1;
  repeated ClassifiedOpinion opinions = 2;
}

message ClassifiedOpinion {
  string text = 1;
  string opinion_type = 2;
}

message ConclusionResponse {
  string conclusion = 1;
}

// Messages for Full Analysis
message TopicAnalysisRequest {
  string topic_id = 1;
  string topic_text = 2;
  repeated Opinion all_opinions = 3;
  int32 top_k = 4;
  bool generate_conclusion = 5;
}

message TopicAnalysisResponse {
  string topic_id = 1;
  repeated MatchedOpinion matched_opinions = 2;
  repeated ClassifiedOpinion classified_opinions = 3;
  optional string conclusion = 4;
  AnalysisMetrics metrics = 5;
}

message AnalysisMetrics {
  int32 total_opinions_analyzed = 1;
  int32 matched_opinions = 2;
  float avg_similarity = 3;
  map<string, int32> type_distribution = 4;
}
